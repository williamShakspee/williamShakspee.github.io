<!DOCTYPE html>
<html lang="en">
<head>
    <title>Responsive YouTube Iframe Block</title>
    <meta charset="utf-8">
    <style>
        /* Styling for the block's user interface in the editor */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #333; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 95%; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        #status { font-style: italic; color: #555; }
    </style>
    <script src="https://raw.githack.com/salesforce-marketingcloud/blocksdk/master/blocksdk.js"></script>
</head>
<body>
    <label for="youtube-url">YouTube Video URL:</label>
    <input type="text" id="youtube-url" placeholder="e.g., https://www.youtube.com/watch?v=...">
    <div id="status">Enter a URL to generate the embed code.</div>

    <script>
        document.addEventListener('DOMContentLoaded', function ( ) {
            
            var sdk = new window.sfdc.BlockSDK();
            var youtubeUrlInput = document.getElementById('youtube-url');
            var statusDiv = document.getElementById('status');
            var debounceTimeout;

            function getYouTubeId(url) {
                if (!url) return null;
                var ID = '';
                url = url.replace(/(>|<)/gi, '').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
                if (url[2] !== undefined) {
                    ID = url[2].split(/[^0-9a-z_\-]/i);
                    ID = ID[0];
                } else {
                    ID = url;
                }
                return ID;
            }

            // Renders the full, interactive iframe for the final published page
            function generateFinalHtml(videoId) {
                const embedUrl = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=0&mute=0`;
                const responsiveCss = `
                    <style>
                        .iframe-outer-wrapper { max-width: 800px; margin: 0 auto; }
                        .iframe-container { position: relative; overflow: hidden; width: 100%; padding-top: 56.25%; }
                        .iframe-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
                    </style>`;
                return `
                    ${responsiveCss}
                    <div class="iframe-outer-wrapper">
                        <div class="iframe-container">
                            <iframe src="${embedUrl}" frameborder="0" allow="autoplay; accelerometer; encrypted-media; gyroscope; fullscreen; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>`;
            }

            // Renders a simple, non-interactive thumbnail for the SFMC preview canvas
            function generatePreviewHtml(videoId ) {
                return `
                    <div style="position: relative; max-width: 800px; margin: 0 auto;">
                        <img src="https://img.youtube.com/vi/${videoId}/0.jpg" alt="YouTube Video Preview" style="width:100%; height:auto; display:block; border:0;">
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background-color:rgba(0,0,0,0.2 );">
                            <img src="https://i.imgur.com/H6T5m8V.png" alt="Play Button" style="width:80px; height:auto; opacity:0.9;">
                        </div>
                        <div style="position:absolute; bottom:0; left:0; width:100%; text-align:center; background-color:rgba(0,0,0,0.6 ); color:white; padding:5px 0; font-family:Arial, sans-serif; font-size:12px;">
                            Live video will be shown on the published page.
                        </div>
                    </div>`;
            }

            function updateBlock() {
                var url = youtubeUrlInput.value;
                var videoId = getYouTubeId(url);
                
                if (!videoId) {
                    statusDiv.textContent = 'Please enter a valid YouTube URL.';
                    sdk.setContent('<div style="padding:20px; text-align:center; font-family: Arial, sans-serif;">Please provide a valid YouTube URL.</div>');
                    sdk.setData({ youtubeUrl: url });
                    return;
                }

                statusDiv.textContent = 'Embed code updated.';
                
                // *** THE CORE LOGIC ***
                // Generate the appropriate HTML for the context
                var previewHtml = generatePreviewHtml(videoId);
                var finalHtml = generateFinalHtml(videoId);

                // Set the content for the PREVIEW canvas
                sdk.setContent(previewHtml);
                
                // Set the content for the FINAL published page
                sdk.setSuperContent(finalHtml);

                // Save the data for re-editing
                sdk.setData({ youtubeUrl: url });
            }

            function debounceUpdate() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(updateBlock, 500);
            }

            sdk.getData(function (data) {
                if (data && data.youtubeUrl) {
                    youtubeUrlInput.value = data.youtubeUrl;
                }
                updateBlock();
            });

            youtubeUrlInput.addEventListener('input', debounceUpdate);
        });
    </script>
</body>
</html>
