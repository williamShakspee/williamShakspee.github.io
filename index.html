<!DOCTYPE html>
<html>
<head>
    <title>YouTube Custom Block (Debounced)</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/blocksdk@1.2.2/blocksdk.js"></script>
</head>
<body>
    <div class="container" style="padding: 20px;">
        <label for="youtube-url">YouTube Video URL:</label>
        <input type="text" id="youtube-url" style="width: 100%; margin-top: 5px;" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <script>
        var sdk = new window.sfdc.BlockSDK( );
        var app = {}; // To hold our app's state

        /**
         * DEBOUNCE FUNCTION
         * This function delays the execution of a function until after a certain time has passed
         * without that function being called. This prevents firing too many events.
         * @param {Function} func The function to debounce.
         * @param {number} wait The delay in milliseconds.
         */
        function debounce(func, wait) {
            var timeout;
            return function() {
                var context = this, args = arguments;
                var later = function() {
                    timeout = null;
                    func.apply(context, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // This is the main function that generates the email-ready HTML
        function createBlockContent(url) {
            if (!url || url.trim() === '') {
                return '<div style="text-align:center; padding: 20px; font-family: Arial, sans-serif;">Enter a YouTube URL to generate a preview.</div>';
            }

            let videoId = null;
            try {
                // Handle short youtu.be links
                if (url.includes('youtu.be/')) {
                    videoId = new URL(url).pathname.slice(1);
                } 
                // Handle standard youtube.com/watch links
                else if (url.includes('youtube.com/watch')) {
                    videoId = new URL(url).searchParams.get('v');
                }
            } catch (e) {
                console.error("Error parsing URL:", e);
                videoId = null;
            }

            if (!videoId) {
                return '<div style="text-align:center; padding: 20px; font-family: Arial, sans-serif; color: red;">Invalid YouTube URL. Please use a valid "watch?v=..." or "youtu.be/..." link.</div>';
            }

            // This is the final HTML that will be inserted into the email
            return `
                <table cellpadding="0" cellspacing="0" width="100%" role="presentation" style="min-width: 100%;" class="stylingblock-content-wrapper">
                    <tr>
                        <td class="stylingblock-content-wrapper camarker-inner" align="center">
                            <a href="${url}" title="YouTube Video" target="_blank" style="text-decoration: none; display: block;">
                                <img src="https://img.youtube.com/vi/${videoId}/0.jpg" alt="YouTube Video Thumbnail" width="100%" style="max-width: 600px; display: block; border: 0; height: auto;">
                            </a>
                        </td>
                    </tr>
                </table>
            `;
        }

        // This function will be called to update SFMC, but only after the user stops typing.
        var debouncedUpdate = debounce(function( ) {
            console.log('Debounced update triggered.');
            
            // Get the current URL from the input field
            var currentUrl = $('#youtube-url').val();
            app.youtubeUrl = currentUrl;
            
            // Generate the HTML content from the URL
            var content = createBlockContent(currentUrl);
            
            // Update the block's preview and save its data
            sdk.setContent(content);
            sdk.setData({ youtubeUrl: currentUrl });

        }, 300); // Wait 300ms after the user stops typing

        // --- SDK Initialization ---
        // This is the entry point.
        window.sfdc.interaction.on('sdkReady', function () {
            console.log('SDK is ready.');
            
            // 1. Get the data that was saved last time
            sdk.getData(function (data) {
                console.log('Initial data received:', data);
                if (data && data.youtubeUrl) {
                    // If we have saved data, populate the input field
                    $('#youtube-url').val(data.youtubeUrl);
                }
                // Trigger an initial update to show the preview for the loaded data
                debouncedUpdate();
            });

            // 2. Listen for changes on our input field and call the debounced function
            $('#youtube-url').on('input', debouncedUpdate);
        });

    </script>
</body>
</html>
