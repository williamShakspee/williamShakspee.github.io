<!DOCTYPE html>
<html>
<head>
    <title>YouTube Custom Block</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Load the Content Builder SDK -->
    <script src="https://unpkg.com/blocksdk@1.2.2/blocksdk.js"></script>
</head>
<body>
    <div class="container" style="padding: 20px;">
        <label for="youtube-url">YouTube Video URL:</label>
        <input type="text" id="youtube-url" style="width: 100%; margin-top: 5px;" placeholder="https://www.youtube.com/watch?v=..." />
    </div>

    <script>
        // Initialize the SDK
        var sdk = new window.sfdc.BlockSDK( );
        var app = {}; // Use a simple object to hold our app's state

        // This is the main function that generates the email-ready HTML
        function createBlockContent(url) {
            if (!url) {
                return '<div>Please enter a YouTube URL to see the video.</div>';
            }

            // Extract the YouTube Video ID from the URL
            let videoId = '';
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                }
            } catch (e) {
                // If the URL is invalid, catch the error
                videoId = null;
            }

            if (!videoId) {
                return '<div>Invalid or incomplete YouTube URL. Please check and try again.</div>';
            }

            // This is the final HTML that will be inserted into the email
            return `
                <table cellpadding="0" cellspacing="0" width="100%" role="presentation" style="min-width: 100%;" class="stylingblock-content-wrapper">
                    <tr>
                        <td class="stylingblock-content-wrapper camarker-inner" align="center">
                            <a href="${url}" title="YouTube Video" target="_blank" style="text-decoration: none;">
                                <img src="https://img.youtube.com/vi/${videoId}/0.jpg" alt="YouTube Video Thumbnail" width="100%" style="max-width: 600px; display: block; border: 0; height: auto;">
                            </a>
                        </td>
                    </tr>
                </table>
            `;
        }

        // This function is called every time the input value changes
        function onInputValueChange( ) {
            // Get the current URL from the input field
            app.youtubeUrl = $('#youtube-url').val();
            
            // Generate the HTML content from the URL
            var content = createBlockContent(app.youtubeUrl);
            
            // Update the block's preview in the editor
            sdk.setContent(content);

            // **CRUCIAL:** Save the data that the block needs to remember for the next time it's opened.
            // This is what populates the input field when you re-edit the block.
            sdk.setData({ youtubeUrl: app.youtubeUrl });
        }

        // --- SDK Initialization ---
        // This is the entry point. SFMC will fire 'sdkReady' when the block is loaded and ready.
        window.sfdc.interaction.on('sdkReady', function () {
            
            // 1. Get the data that was saved last time
            sdk.getData(function (data) {
                if (data && data.youtubeUrl) {
                    // If we have saved data, populate the input field
                    app.youtubeUrl = data.youtubeUrl;
                    $('#youtube-url').val(app.youtubeUrl);
                }
                // Now that the UI is populated, trigger an initial update
                onInputValueChange();
            });

            // 2. Listen for changes on our input field
            $('#youtube-url').on('input', onInputValueChange);
        });

    </script>
</body>
</html>
